# 数据库事务

#### 概述

事务是 一系列 对系统中数据 进行访问与更新  的操作所组成的 一个**程序执行逻辑单元**

- **事务的基本特征ACID**

  - **原子性**（Atomicity)
    - 要么全部执行成功，要么全部执行失败
    - 一项操作失败则其他的操作回滚
  - **一致性**（Consistency)
    - 事务执行前后 数据库处于一致性状态
    - （A账号转到B账号   不能A-了而B没有+）
  - **隔离性** （Isolation)
    - 并发环境下，事务之间相互隔离 不能相互干扰
  - **持久性**  （Duration)
    - 提交成功后，数据就永久的被保存下来。
    - 即使系统奔溃，只要重启就可以恢复发哦成功结束后的状态

- **事务的隔离级别**

  - **读未提交** （READ_UNCOMMITTED)

    - 级别最低

    - 一个事务正在处理过程中允许另一个事务对数据进行操作

    - （脏读问题）

      | 时间 | 事务A（存款）          | 事务B（取款）              |
      | ---- | ---------------------- | -------------------------- |
      | T1   | 开始事务               | ——                         |
      | T2   | ——                     | 开始事务                   |
      | T3   | ——                     | 查询余额（1000元）         |
      | T4   | ——                     | 取出1000元（余额0元）      |
      | T5   | 查询余额（0元）        | ——                         |
      | T6   | ——                     | 撤销事务（余额恢复1000元） |
      | T7   | 存入500元（余额500元） | ——                         |
      | T8   | 提交事务               | ——                         |

      - T5时候A查询为脏数据

  - **读已提交** （READ_COMMITTED)

    - 只能获取已经提交的数据

    - （不会出现脏读）

    - （但是会出现不可重复读问题）

      | 时间 | 事务A（存款）      | 事务B（取款）         |
      | ---- | ------------------ | --------------------- |
      | T1   | 开始事务           | ——                    |
      | T2   | ——                 | 开始事务              |
      | T3   | ——                 | 查询余额（1000元）    |
      | T4   | 查询余额（1000元） | ——                    |
      | T5   | ——                 | 取出1000元（余额0元） |
      | T6   | ——                 | 提交事务              |
      | T7   | 查询余额（0元）    | ——                    |
      | T8   | 提交事务           | ——                    |

      - A查询两次 余额发生了改变

  - **可重复读** （Unrepeatable)

    - 多次读取数据时候，数据的值和事务开始时刻的值是一致的

    - （不会出现脏读和不可重复读问题）

    - （但是会出现幻读问题）

      | 时间 | 事务A（统计总存款）  | 事务B（存款） |
      | ---- | -------------------- | ------------- |
      | T1   | 开始事务             | ——            |
      | T2   | ——                   | 开始事务      |
      | T3   | 统计总存款（1000元） | ——            |
      | T4   | ——                   | 存入100元     |
      | T5   | ——                   | 提交事务      |
      | T6   | 提交总存款（10100）  | ——            |
      | T7   | 提交事务             | ——            |

      - 同样的事务操作，在同一个时间对同一个数据读取可能出现不一致的结果

  - **顺序读** （SERIALIZABLE)

    - 要求所有的事务顺序执行，不能并发

- **事务的问题**

  > 在不同的隔离性级别 并发访问下
  - 脏读 （Dirty Read)
  - 不可重复读（Unrepeatable Read)
  - 幻读 （Phantom Read)
